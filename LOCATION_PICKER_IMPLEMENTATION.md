# 位置选择页面实现说明

## 📍 功能概述

实现了一个全新的位置选择页面，用于在聊天功能中选择和发送位置信息。

## 🎨 UI 设计

### 页面布局

```
┌─────────────────────────────────────┐
│  🔙 返回按钮 (左上角)                │
│                                     │
│         全屏地图显示区域             │
│      (显示选中位置的标记)            │
│                                     │
├─────────────────────────────────────┤
│  ╔═══════════════════════════════╗  │
│  ║  🔍 搜索框                    ║  │
│  ╠═══════════════════════════════╣  │
│  ║  📍 当前位置         ✓       ║  │
│  ║  📍 附近地点 1               ║  │
│  ║  📍 附近地点 2               ║  │
│  ║  📍 附近地点 3               ║  │
│  ╠═══════════════════════════════╣  │
│  ║      [确认发送按钮]           ║  │
│  ╚═══════════════════════════════╝  │
└─────────────────────────────────────┘
```

### 详细规格

#### 1️⃣ 顶部返回按钮
- **位置**: 左上角 (safe area + 12px, 左侧 16px)
- **图标**: `assets/kissu_mine_back.webp`
- **尺寸**: 22x22

#### 2️⃣ 地图区域
- **显示**: 全屏展示
- **交互**: 支持缩放、拖拽、旋转、倾斜
- **标记**: 显示选中位置的圆形头像标记

#### 3️⃣ 底部功能区
- **背景**: 白色
- **圆角**: 左上右上 24px
- **包含模块**:

##### 模块1: 地址搜索框
- **高度**: 44px
- **边框**: 2px, 颜色 #FF9DC4
- **背景**: 白色
- **圆角**: 22px
- **占位符**: "搜索地点"
- **图标**: 粉色搜索图标

##### 模块2: 附近地址列表
- **最大高度**: 280px
- **可滚动**: 是
- **第一项**: 当前位置（特殊标记）
- **其他项**: 附近的地址
- **选中效果**: 
  - 背景色 #FFF5F9
  - 右侧显示粉色勾选图标
- **每一项包含**:
  - 位置图标 (当前位置用 `my_location`, 其他用 `location_on_outlined`)
  - 位置名称 (15pt, #333333)
  - 地址详情 (12pt, 灰色)
  - 选中图标 (粉色 check_circle)

##### 模块3: 确认按钮
- **宽度**: 全宽 (左右边距 20px)
- **高度**: 48px
- **背景色**: #FF9DC4
- **文字**: "确认发送" (16pt, 白色, 粗体)
- **圆角**: 24px
- **阴影**: 无

## 📁 文件结构

```
lib/pages/chat/
├── widgets/
│   ├── location_picker_page.dart    # 新增：位置选择页面
│   ├── chat_message_item.dart       # 已修改：位置预览详情页
│   └── ...
├── chat_controller.dart              # 已修改：集成位置选择
└── utils/
    └── map_marker_util.dart
```

## 🔧 核心实现

### LocationPickerPage 类

```dart
class LocationPickerPage extends StatefulWidget
```

**主要功能**:
1. 显示当前位置和附近位置列表
2. 支持地图实时预览选中位置
3. 支持搜索地点（预留接口）
4. 选择位置后返回给调用方

**数据模型**:
```dart
class LocationInfo {
  final String name;           // 位置名称
  final String? address;       // 详细地址
  final double latitude;       // 纬度
  final double longitude;      // 经度
  final bool isCurrentLocation; // 是否为当前位置
}
```

### ChatController 集成

**修改的方法**: `_pickAndSendLocation()`

**流程**:
1. 获取当前定位信息
2. 打开位置选择页面（全屏从下往上过渡动画）
3. 用户选择位置并确认
4. 创建位置消息并发送
5. 刷新聊天列表

## 🎯 使用场景

1. **聊天扩展面板** → 点击"位置"图标 → 打开位置选择页面
2. 在位置选择页面中:
   - 查看地图上的当前位置
   - 浏览附近位置列表
   - 搜索特定地点（待实现）
   - 选择一个位置
   - 点击"确认发送"按钮
3. 位置信息作为消息发送到聊天窗口

## 🚀 后续扩展

### 待实现功能

1. **搜索功能**
   - 集成高德地图 POI 搜索 API
   - 实时搜索建议
   - 搜索历史记录

2. **附近位置**
   - 使用高德地图周边搜索 API
   - 自动获取附近 POI
   - 分类显示（餐饮、商场、交通等）

3. **地图交互**
   - 支持拖动地图选点
   - 点击地图标记查看详情
   - 地图样式切换

4. **用户体验优化**
   - 添加加载状态
   - 错误处理和提示
   - 位置权限引导
   - 骨架屏

## 📝 资源文件

### 必需的图片资源

- ✅ `assets/kissu_mine_back.webp` - 返回按钮图标
- ✅ `assets/chat/kissu3_map_preview_bg.webp` - 地图预览背景（位置详情页使用）
- ✅ `assets/chat/kissu3_chat_location.webp` - 位置功能图标

### 依赖项

- `amap_flutter_base` - 高德地图基础组件
- `amap_flutter_map` - 高德地图显示
- `get` - 路由和状态管理

## 🎨 颜色规范

- **主题粉色**: #FF9DC4 (边框、按钮、选中状态)
- **文字主色**: #333333
- **文字辅色**: #999999 / Colors.grey[600]
- **背景色**: #FFFFFF
- **选中背景**: #FFF5F9

## ✅ 测试要点

- [ ] 地图正常加载并显示标记
- [ ] 位置列表正常显示
- [ ] 点击列表项能切换选中状态
- [ ] 地图随选中位置更新
- [ ] 点击确认按钮返回选中位置
- [ ] 点击返回按钮取消选择
- [ ] 页面过渡动画流畅
- [ ] 搜索框 UI 显示正常（功能待实现）

