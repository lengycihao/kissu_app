<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:tools="http://schemas.android.com/tools"
    package="com.yuluo.kissu">
    <application
        android:label="Kissu"
        android:name="${applicationName}"
        android:icon="@mipmap/ic_launcher"
        android:networkSecurityConfig="@xml/network_security_config"
        android:usesCleartextTraffic="true"
        android:enableOnBackInvokedCallback="true"
        android:dataExtractionRules="@xml/data_extraction_rules"
        android:fullBackupContent="@xml/backup_rules"
        android:requestLegacyExternalStorage="false"
        android:preserveLegacyExternalStorage="false">
        <!-- 友盟分享配置 -->
        <meta-data
            android:name="UMENG_APPKEY"
            android:value="6879fbe579267e0210b67be9" />
        <meta-data
            android:name="UMENG_CHANNEL"
            android:value="Umeng" />
        <activity
            android:name=".MainActivity"
            android:exported="true"
            android:launchMode="singleTop"
            android:taskAffinity=""
            android:theme="@style/TransparentTheme"
            android:configChanges="orientation|keyboardHidden|keyboard|screenSize|smallestScreenSize|locale|layoutDirection|fontScale|screenLayout|density|uiMode"
            android:hardwareAccelerated="true"
            android:windowSoftInputMode="adjustResize">
            <intent-filter>
                <action android:name="android.intent.action.MAIN"/>
                <category android:name="android.intent.category.LAUNCHER"/>
            </intent-filter>
            <!-- Specifies an Android theme to apply to this Activity as soon as
                 the Android process has started. This theme is visible to the user
                 while the Flutter UI initializes. After that, this theme continues
                 to determine the Window background behind the Flutter UI. -->
            <meta-data
              android:name="io.flutter.embedding.android.NormalTheme"
              android:resource="@style/NormalTheme"
              />
            <!-- 支付宝支付回调 -->
            <intent-filter>
                <action android:name="android.intent.action.VIEW" />
                <category android:name="android.intent.category.DEFAULT" />
                <category android:name="android.intent.category.BROWSABLE" />
                <data android:scheme="alipaykissu" />
            </intent-filter>
            
            <!-- OpenInstall Scheme配置 -->
            <intent-filter>
                <action android:name="android.intent.action.VIEW" />
                <category android:name="android.intent.category.DEFAULT" />
                <category android:name="android.intent.category.BROWSABLE" />
                <data android:scheme="eb24o3" />
            </intent-filter>
        </activity>
        
        <!-- 微信回调 Activity：支付/分享/登录 -->
        <activity
            android:name="com.yuluo.kissu.wxapi.WXPayEntryActivity"
            android:exported="true"
            android:launchMode="singleTop"
            android:theme="@android:style/Theme.Translucent.NoTitleBar" />

        <activity
            android:name="com.yuluo.kissu.wxapi.WXEntryActivity"
            android:exported="true"
            android:launchMode="singleTop"
            android:theme="@android:style/Theme.Translucent.NoTitleBar">
            <intent-filter>
                <action android:name="android.intent.action.VIEW" />
                <category android:name="android.intent.category.DEFAULT" />
                <data android:scheme="wxca15128b8c388c13" />
            </intent-filter>
            <!-- 微信Universal Link配置 -->
            <intent-filter android:autoVerify="true">
                <action android:name="android.intent.action.VIEW" />
                <category android:name="android.intent.category.DEFAULT" />
                <category android:name="android.intent.category.BROWSABLE" />
                <data android:scheme="https"
                      android:host="ulink.ikissu.cn" />
            </intent-filter>
        </activity>
        
        <!-- 友盟微信分享回调Activity -->
        <activity
            android:name="com.yuluo.kissu.wxapi.UMWXEntryActivity"
            android:exported="true"
            android:launchMode="singleTop"
            android:theme="@android:style/Theme.Translucent.NoTitleBar" />
            
        <!-- QQ分享回调Activity - 使用友盟推荐的配置 -->
        <activity
            android:name="com.yuluo.kissu.qqapi.QQEntryActivity"
            android:exported="true"
            android:launchMode="singleTop"
            android:theme="@android:style/Theme.Translucent.NoTitleBar">
            <intent-filter>
                <action android:name="android.intent.action.VIEW" />
                <category android:name="android.intent.category.DEFAULT" />
                <category android:name="android.intent.category.BROWSABLE" />
                <data android:scheme="tencent102797447" />
            </intent-filter>
        </activity>
        
        <!-- 腾讯官方QQ回调Activity - 作为备用 -->
        <activity
            android:name="com.tencent.tauth.AuthActivity"
            android:exported="true"
            android:noHistory="true"
            android:launchMode="singleTask">
            <intent-filter>
                <action android:name="android.intent.action.VIEW" />
                <category android:name="android.intent.category.DEFAULT" />
                <category android:name="android.intent.category.BROWSABLE" />
                <data android:scheme="tencent102797447" />
            </intent-filter>
        </activity>

        <!-- QQ SDK 必需的辅助 Activity -->
        <activity
            android:name="com.tencent.connect.common.AssistActivity"
            android:screenOrientation="behind"
            android:theme="@android:style/Theme.Translucent.NoTitleBar"
            android:configChanges="orientation|keyboardHidden" />
            
        <!-- 支付宝支付Activity -->
        <activity
            android:name="com.alipay.sdk.app.H5PayActivity"
            android:exported="false"
            android:launchMode="singleTop"
            android:screenOrientation="behind"
            android:windowSoftInputMode="adjustResize|stateHidden" />
            
        <!-- 支付宝授权Activity -->
        <activity
            android:name="com.alipay.sdk.app.H5AuthActivity"
            android:exported="false"
            android:launchMode="singleTop"
            android:screenOrientation="behind"
            android:windowSoftInputMode="adjustResize|stateHidden" />
            
        <!-- 支付宝支付回调Activity -->
        <activity
            android:name="com.yuluo.kissu.pay.AlipayActivity"
            android:exported="true"
            android:launchMode="singleTop"
            android:theme="@android:style/Theme.Translucent.NoTitleBar" />
            
            
        <!-- Don't delete the meta-data below.
             This is used by the Flutter tool to generate GeneratedPluginRegistrant.java -->
        <meta-data
            android:name="flutterEmbedding"
            android:value="2" />
            
        <!-- 微信/QQ 配置 -->
        <meta-data
            android:name="WECHAT_APP_ID"
            android:value="wxca15128b8c388c13" />
        <meta-data
            android:name="TENCENT_QQ_APPID"
            android:value="102797447" />
        <meta-data
            android:name="TENCENT_QQ_APPKEY"
            android:value="c5KJ2VipiMRMCpJf" />
            
        <!-- 支付宝配置 -->
        <meta-data
            android:name="ALIPAY_SCHEME"
            android:value="alipaykissu" />
            
        <!-- 高德地图API Key -->
        <meta-data
            android:name="com.amap.api.v2.apikey"
            android:value="38edb925a25f22e3aae2f86ce7f2ff3b" />
            
        <!-- 极光推送配置 -->
        <meta-data
            android:name="JPUSH_CHANNEL"
            android:value="developer-default"
            tools:replace="android:value" />
        <meta-data
            android:name="JPUSH_APPKEY"
            android:value="4ee497251fc479522e1e6b7d"
            tools:replace="android:value" />
        <meta-data
            android:name="JPUSH_MASTER_SECRET"
            android:value="73394575cf91ff845b03f25e"
            tools:replace="android:value" />
            
        <!-- 自定义通知样式配置 -->
        <meta-data
            android:name="JPUSH_NOTIFICATION_ICON"
            android:resource="@drawable/ic_notification" />
        <meta-data
            android:name="JPUSH_NOTIFICATION_COLOR"
            android:resource="@color/notification_color" />
            
        <!-- 极光推送核心接收器 - 重要的系统接收器 -->
        <receiver
            android:name="cn.jpush.android.service.PushReceiver"
            android:enabled="true"
            android:exported="false">
            <intent-filter android:priority="1000">
                <action android:name="cn.jpush.android.intent.NOTIFICATION_RECEIVED_PROXY" />
                <category android:name="com.yuluo.kissu" />
            </intent-filter>
            <intent-filter>
                <action android:name="android.intent.action.USER_PRESENT" />
                <action android:name="android.net.conn.CONNECTIVITY_CHANGE" />
            </intent-filter>
            <intent-filter>
                <action android:name="android.intent.action.PACKAGE_ADDED" />
                <action android:name="android.intent.action.PACKAGE_REMOVED" />
                <data android:scheme="package" />
            </intent-filter>
            <intent-filter>
                <action android:name="android.intent.action.BOOT_COMPLETED" />
            </intent-filter>
        </receiver>
        
        <!-- 极光推送警报接收器 -->
        <receiver
            android:name="cn.jpush.android.service.AlarmReceiver"
            android:exported="false" />
        
        <!-- 自定义推送接收器 -->
        <receiver
            android:name="com.yuluo.kissu.JPushReceiver"
            android:enabled="true"
            android:exported="false">
            <intent-filter android:priority="1001">
                <action android:name="cn.jpush.android.intent.NOTIFICATION_RECEIVED_ACTION" />
                <action android:name="cn.jpush.android.intent.NOTIFICATION_OPENED_ACTION" />
                <action android:name="cn.jpush.android.intent.REGISTRATION_ID" />
                <action android:name="cn.jpush.android.intent.MESSAGE_RECEIVED_ACTION" />
                <action android:name="cn.jpush.android.intent.CONNECTION_CHANGE" />
                <category android:name="com.yuluo.kissu" />
            </intent-filter>
        </receiver>
        
        <!-- 高德定位服务 -->
        <service android:name="com.amap.api.location.APSService" />
        
        <!-- 极光推送核心服务 - 这是关键的服务 -->
        <service
            android:name="cn.jpush.android.service.PushService"
            android:enabled="true"
            android:exported="false">
            <intent-filter>
                <action android:name="cn.jpush.android.intent.REGISTER" />
                <action android:name="cn.jpush.android.intent.REPORT" />
                <action android:name="cn.jpush.android.intent.PushService" />
                <action android:name="cn.jpush.android.intent.PUSH_TIME" />
            </intent-filter>
        </service>
        
        <!-- 极光推送消息服务 -->
        <service
            android:name="cn.jpush.android.service.JPushMessageService"
            android:enabled="true"
            android:exported="false">
            <intent-filter>
                <action android:name="cn.jpush.android.intent.MESSAGE_RECEIVED_ACTION" />
            </intent-filter>
        </service>
        
        <!-- 自定义JPush后台服务 -->
        <service
            android:name="com.yuluo.kissu.JPushService"
            android:enabled="true"
            android:exported="false"
            android:foregroundServiceType="dataSync"
            android:permission="android.permission.BIND_JOB_SERVICE"
            android:stopWithTask="false" />
        
        <!-- 前台定位服务 -->
        <service
            android:name="com.yuluo.kissu.ForegroundLocationService"
            android:enabled="true"
            android:exported="false"
            android:foregroundServiceType="location"
            android:permission="android.permission.BIND_JOB_SERVICE"
            android:stopWithTask="false" />
        
        <!-- 极光推送Activity -->
        <activity
            android:name="cn.jpush.android.ui.PushActivity"
            android:configChanges="orientation|keyboardHidden"
            android:exported="false"
            android:theme="@android:style/Theme.Translucent.NoTitleBar"
            tools:replace="android:exported,android:theme" />
            
        <!-- 极光推送通知点击Activity -->
        <activity
            android:name="cn.jpush.android.ui.PopWinActivity"
            android:configChanges="orientation|keyboardHidden"
            android:exported="false"
            android:theme="@android:style/Theme.Translucent.NoTitleBar"
            tools:replace="android:exported,android:theme" />
            
        <!-- 极光推送数据提供者 -->
        <provider
            android:name="cn.jpush.android.service.DataProvider"
            android:authorities="com.yuluo.kissu.DataProvider"
            android:exported="false" />
            
        <!-- 极光推送初始化Provider - 隐私合规：禁用自动初始化 -->
        <!-- 
        <provider
            android:name="cn.jpush.android.service.InitProvider"
            android:authorities="${applicationId}.jpush.initprovider"
            android:exported="false"
            tools:replace="android:authorities" />
        -->
            
        <!-- 微信分享FileProvider配置 -->
        <provider
            android:name="androidx.core.content.FileProvider"
            android:authorities="${applicationId}.fileprovider"
            android:exported="false"
            android:grantUriPermissions="true">
            <meta-data
                android:name="android.support.FILE_PROVIDER_PATHS"
                android:resource="@xml/file_paths" />
        </provider>
        
        <!-- 图片裁剪Activity -->
        <activity
            android:name="com.yalantis.ucrop.UCropActivity"
            android:screenOrientation="portrait"
            android:theme="@style/Theme.AppCompat.Light.NoActionBar" />
    </application>

    <!-- 相机权限：用于拍照上传头像、图片等功能 -->
    <uses-permission android:name="android.permission.CAMERA"/>
    <!-- 存储权限：用于读取和保存图片、文件等，以及推送消息的缓存和日志 -->
    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/>
    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"/>
    
    <!-- 网络状态权限：用于检测网络连接状态，确保地图加载和数据同步 -->
    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
    
    <!-- WiFi状态权限：用于支付功能、网络优化和推送服务网络状态监听 -->
    <uses-permission android:name="android.permission.ACCESS_WIFI_STATE" />
    <uses-permission android:name="android.permission.CHANGE_WIFI_STATE" />
    <!-- 电话状态权限：高德地图SDK需要，用于设备标识 -->
    <uses-permission android:name="android.permission.READ_PHONE_STATE" />
    <!-- 电话号码权限：Android 10+使用，用于设备标识 -->
    <uses-permission android:name="android.permission.READ_PHONE_NUMBERS" />
    <!-- 唤醒锁权限：保持CPU运行，用于后台定位和推送服务 -->
    <uses-permission android:name="android.permission.WAKE_LOCK" />
    <!-- 震动权限：用于通知提醒和交互反馈 -->
    <uses-permission android:name="android.permission.VIBRATE" />
    
    <!-- 粗略定位权限：用于获取大致位置信息，提供基于位置的服务 -->
    <uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" />
    <!-- 精确定位权限：用于获取精确位置信息，实现定位打卡等功能 -->
    <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
    <!-- 定位扩展命令权限：用于高级定位功能 -->
    <uses-permission android:name="android.permission.ACCESS_LOCATION_EXTRA_COMMANDS" />
    <!-- 定位更新控制权限：用于控制定位服务的更新频率 -->
    <uses-permission android:name="android.permission.CONTROL_LOCATION_UPDATES" />
    <!-- 后台定位权限：用于在应用后台时继续获取位置信息，实现智能提醒功能 -->
    <uses-permission android:name="android.permission.ACCESS_BACKGROUND_LOCATION" />
    <!-- 网络访问权限：用于数据传输、API调用、地图服务等 -->
    <uses-permission android:name="android.permission.INTERNET" />
    
    <!-- 极光推送相关权限 -->
 
    <!-- 开机自启权限：用于在设备重启后自动启动推送服务 -->
    <uses-permission android:name="android.permission.RECEIVE_BOOT_COMPLETED" />
    <!-- 网络状态变更权限：用于推送服务网络状态监听（已在WiFi权限部分声明） -->
    <!-- 外部存储写入权限：用于推送消息的缓存和日志（已在存储权限部分声明） -->
    <!-- 获取任务列表权限：用于检测应用运行状态（已弃用，保留兼容性） -->
    <uses-permission android:name="android.permission.GET_TASKS" />
    <!-- 系统窗口权限：用于显示悬浮窗通知（需用户手动授权） -->
    <uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW" />
    <!-- 忽略电池优化权限：确保后台服务不被系统杀死 -->
    <uses-permission android:name="android.permission.REQUEST_IGNORE_BATTERY_OPTIMIZATIONS" />
    
    <!-- 前台服务权限：用于运行长期后台任务 -->
    <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />
    <!-- 前台定位服务权限：用于前台定位服务（Android 10+必需） -->
    <uses-permission android:name="android.permission.FOREGROUND_SERVICE_LOCATION" />
    <!-- 前台数据同步服务权限：用于推送服务（Android 14+必需） -->
    <uses-permission android:name="android.permission.FOREGROUND_SERVICE_DATA_SYNC" />
    <!-- 任务调度权限：用于后台服务（Android 14+优化） -->
    <uses-permission android:name="android.permission.SCHEDULE_EXACT_ALARM" />
    <!-- 读取媒体图片权限：Android 13+替代READ_EXTERNAL_STORAGE -->
    <uses-permission android:name="android.permission.READ_MEDIA_IMAGES" />
    <!-- 读取媒体视频权限：Android 13+替代READ_EXTERNAL_STORAGE -->
    <uses-permission android:name="android.permission.READ_MEDIA_VIDEO" />
    
    <!-- Android 16 新增权限 -->
    <!-- 部分照片访问权限：Android 16+ 更精细的媒体访问控制 -->
    <uses-permission android:name="android.permission.READ_MEDIA_VISUAL_USER_SELECTED" />
    <!-- 通知权限：Android 13+必需，Android 16更严格 -->
    <uses-permission android:name="android.permission.POST_NOTIFICATIONS" />
    
    <!-- 精确闹钟权限：Android 16+优化 -->
    <uses-permission android:name="android.permission.USE_EXACT_ALARM" />

    <!-- Required to query activities that can process text, see:
         https://developer.android.com/training/package-visibility and
         https://developer.android.com/reference/android/content/Intent#ACTION_PROCESS_TEXT.

         In particular, this is used by the Flutter engine in io.flutter.plugin.text.ProcessTextPlugin. -->
    <queries>
        <intent>
            <action android:name="android.intent.action.PROCESS_TEXT"/>
            <data android:mimeType="text/plain"/>
        </intent>
        <!-- 查询微信 / QQ 应用是否存在，用于可用性检查与调起 -->
        <package android:name="com.tencent.mm" />
        <package android:name="com.tencent.mobileqq" />
        <package android:name="com.tencent.tim" />
        <package android:name="com.tencent.qqlite" />
        <!-- QQ SSO/分享使用的自定义协议，Android 11+ 需显式声明 -->
        <intent>
            <action android:name="android.intent.action.VIEW" />
            <data android:scheme="mqqapi" />
        </intent>
        <!-- 覆盖国际版QQ包名 -->
        <package android:name="com.tencent.mobileqqi" />
        <!-- 查询支付宝应用是否存在，用于支付功能 -->
        <package android:name="com.eg.android.AlipayGphone" />
    </queries>
</manifest>
